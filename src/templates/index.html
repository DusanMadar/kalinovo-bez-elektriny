{% extends "layout.html" %}

{% block title %}Kalinovo ğŸš« âš¡ ğŸ”Œ {% endblock %}

{% block content %}

<div class="pt-4 pb-4">
  <p>
    V obci <a href="https://www.kalinovo.sk/" alt="Kalinovo">Kalinovo</a>
    Äasto vypadÃ¡va elektrina. Tento web zobrazuje zaznamenanÃ© preruÅ¡enia.
  </p>
</div>

<div>
  <h3>ZaznamenanÃ© preruÅ¡enia distribÃºcie elektriny</h3>

  <div class="mb-4">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="chartTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab" aria-controls="yearly" aria-selected="false">
          RoÄnÃ½ prehÄ¾ad
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="by-year-tab" data-bs-toggle="tab" data-bs-target="#by-year" type="button" role="tab" aria-controls="by-year" aria-selected="true">
          MesaÄnÃ½ prehÄ¾ad
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="false">
          DennÃ½ prehÄ¾ad
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hourly-tab" data-bs-toggle="tab" data-bs-target="#hourly" type="button" role="tab" aria-controls="hourly" aria-selected="false">
          HodinovÃ½ prehÄ¾ad
        </button>
      </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content pt-3" id="chartTabsContent">
      <div class="tab-pane fade" id="yearly" role="tabpanel" aria-labelledby="yearly-tab">
        <canvas id="yearlyTotalsChart"></canvas>
      </div>
      <div class="tab-pane fade show active" id="by-year" role="tabpanel" aria-labelledby="by-year-tab">
        <canvas id="monthlyByYearChart"></canvas>
      </div>
      <div class="tab-pane fade" id="daily" role="tabpanel" aria-labelledby="daily-tab">
        <canvas id="dailyByYearChart"></canvas>
      </div>
      <div class="tab-pane fade" id="hourly" role="tabpanel" aria-labelledby="hourly-tab">
        <canvas id="hourlyByYearChart"></canvas>
      </div>
    </div>
  </div>

    {% for year, daily_data in outages_by_year_and_day.items() %}
    <div class="accordion accordion-flush" id="accordionFlush">
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ year }}" style="border-bottom: 0.1rem solid;">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ year}}" aria-expanded="false" aria-controls="collapse-{{ year}}">
            {{ year }}
          </button>
        </h2>
        <div id="collapse-{{ year}}" class="accordion-collapse collapse {% if year == current_year %} show {% endif %}" aria-labelledby="heading-{{ year }}" data-bs-parent="#accordionFlush">
          <div class="accordion-body">
            <div class="row">
              <div class="col">
                {% for date, times in daily_data.items() %}
                  {{ date }}
                  <ul style="padding-left: 1.5rem;">
                    {% for start, stop in times %}
                    <li>{{ start }} - {{ stop }}</li>
                    {% endfor %}
                  </ul>
                {% endfor %}
              </div>

              <div class="col">
                {% for key, count in outages_by_year_and_day_agg[year].counts.items() %}
                <div class="row">
                  <div>
                    <span class="float-end float-md-start">{{ key }}</span>
                  </div>
                  <div>
                    <b class="float-end float-md-start" style="font-size: 1.5rem">{{ count }}</b>
                  </div>
                </div>
                {% endfor %}

                &nbsp;

                {% for time_range, count in outages_by_year_and_day_agg[year].time_ranges.items() %}
                <div class="row">
                  <div>
                    <span class="float-end float-md-start">{{ time_range }}</span>
                  </div>
                  <div>
                    <b class="float-end float-md-start" style="font-size: 1.35rem">{{ count }}</b>
                  </div>
                </div>
                {% endfor %}

                &nbsp;

                {% for weekday, count in outages_by_year_and_day_agg[year].weekday_count.items() %}
                <div class="row">
                  <div>
                    <span class="float-end float-md-start">{{ weekday }}</span>
                  </div>
                  <div>
                    <b class="float-end float-md-start" style="font-size: 1.20rem">{{ count }}</b>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

&nbsp;
<div class="pt-4">
  <p>
    DÃ¡ta sÃº zbieranÃ© na zariadenÃ­ <a href="https://www.raspberrypi.org/">Raspberry Pi</a>,
    na ktorom je nepretrÅ¾ite spustenÃ½ software <a href="https://github.com/DusanMadar/raspberry-pi-downtime-monitor">raspberry-pi-downtime-monitor</a>.
  </p>
  <div class="alert alert-warning" role="alert">
    PresnosÅ¥ ÄasovÃ½ch zÃ¡znamov je <b>cca 30 sekÃºnd aÅ¾ 1 minÃºta</b>
    <ul class="pt-1">
      <li>systÃ©m kaÅ¾dÃ½ch 30 sekÃºnd uloÅ¾Ã­ aktuÃ¡lny Äas</li>
      <li>po vÃ½padku prÃºdu
        <ul>
          <li>sa systÃ©m automaticky naÅ¡tartuje (cca 15 sekÃºnd)</li>
          <li>zaznamenÃ¡ poslednÃ½ znÃ¡my ÄasovÃ½ zÃ¡znam (viÄ. prvÃ½ bod) a Äas Å¡tartu systÃ©mu</li>
        </ul>
      </li>
    </ul>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Simple color palette
const colors = [
  '#e74c3c', // red
  '#3498db', // blue
  '#2ecc71', // green
  '#f39c12', // orange
  '#9b59b6', // purple
  '#1abc9c'  // teal
];

const commonOptions = {
  responsive: true,
  interaction: {
    intersect: false,
    mode: 'index'
  },
  plugins: {
    legend: {
      display: true,
      position: 'top'
    }
  },
  scales: {
    y: {
      beginAtZero: true,
      ticks: {
        stepSize: 1
      },
      title: {
        display: true,
        text: 'PoÄet vÃ½padkov'
      }
    },
    x: {
      title: {
        display: true,
        text: 'Mesiac'
      }
    }
  }
};

// Chart 1: Yearly totals (bar chart)
const yearlyTotalsData = {{ yearly_totals_chart | tojson }};

// Use the same color palette for consistency
const barColors = yearlyTotalsData.labels.map((_, index) => colors[index % colors.length]);
const barBackgroundColors = barColors.map(color => color.replace(')', ', 0.7)').replace('rgb', 'rgba'));

const yearlyTotalsDatasets = yearlyTotalsData.datasets.map((dataset) => ({
  label: dataset.label,
  data: dataset.data,
  backgroundColor: barBackgroundColors,
  borderColor: barColors,
  borderWidth: 2
}));

new Chart(document.getElementById('yearlyTotalsChart'), {
  type: 'bar',
  data: {
    labels: yearlyTotalsData.labels,
    datasets: yearlyTotalsDatasets
  },
  options: {
    responsive: true,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: {
        display: false
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 10
        },
        title: {
          display: true,
          text: 'PoÄet vÃ½padkov'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Rok'
        }
      }
    }
  }
});

// Chart 2: Monthly outages by year
const monthlyByYearData = {{ monthly_by_year_chart | tojson }};
const monthlyByYearDatasets = monthlyByYearData.datasets.map((dataset, index) => ({
  label: dataset.label,
  data: dataset.data,
  borderColor: colors[index % colors.length],
  tension: 0.1,
  fill: false
}));

new Chart(document.getElementById('monthlyByYearChart'), {
  type: 'line',
  data: {
    labels: monthlyByYearData.labels,
    datasets: monthlyByYearDatasets
  },
  options: commonOptions
});

// Chart 3: Daily (weekday) overview by year
const dailyByYearData = {{ daily_by_year_chart | tojson }};
const dailyByYearDatasets = dailyByYearData.datasets.map((dataset, index) => ({
  label: dataset.label,
  data: dataset.data,
  borderColor: colors[index % colors.length],
  tension: 0.1,
  fill: false
}));

new Chart(document.getElementById('dailyByYearChart'), {
  type: 'line',
  data: {
    labels: dailyByYearData.labels,
    datasets: dailyByYearDatasets
  },
  options: {
    responsive: true,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: {
        display: true,
        position: 'top'
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        title: {
          display: true,
          text: 'PoÄet vÃ½padkov'
        }
      },
      x: {
        title: {
          display: true,
          text: 'DeÅˆ v tÃ½Å¾dni'
        }
      }
    }
  }
});

// Chart 4: Hourly (time range) overview by year
const hourlyByYearData = {{ hourly_by_year_chart | tojson }};
const hourlyByYearDatasets = hourlyByYearData.datasets.map((dataset, index) => ({
  label: dataset.label,
  data: dataset.data,
  borderColor: colors[index % colors.length],
  tension: 0.1,
  fill: false
}));

new Chart(document.getElementById('hourlyByYearChart'), {
  type: 'line',
  data: {
    labels: hourlyByYearData.labels,
    datasets: hourlyByYearDatasets
  },
  options: {
    responsive: true,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: {
        display: true,
        position: 'top'
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        title: {
          display: true,
          text: 'PoÄet vÃ½padkov'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Rozsah Äasu'
        }
      }
    }
  }
});
</script>
{% endblock %}
